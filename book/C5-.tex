\documentclass[DynamicalBook]{subfiles}
\begin{document}
%


\setcounter{chapter}{4}%Just finished 4.


%------------ Chapter ------------%
\chapter{Polynomial `time'}\label{chapter.5}

%-------- Section --------%
\section{Introduction}

In \cref{chapter.4} we saw that the category $\poly$ of polynomial functors---otherwise known as dependent lenses---is a very well-behaved category in which to think about dynamical systems of quite a general nature.

But we left one thing---what in some sense is the most interesting part of the story---out entirely. That thing is quite simple to state, and yet has profound consequences. Namely: polynomials can be composed:
\[
\yon^\2\circ(\yon+\1)=(\yon+\1)^\2\cong\yon^\2+\2\yon+\1
\]
What could be simpler?

It turns out that this operation, which we'll see soon is a monoidal product, has a lot to do with time. There is a strong sense---made precise in \cref{?}---in which the polynomial $p\circ q$ represents ``starting at a position $i$ in $p$, choosing a direction in $p_i$, landing at a position $j$ in $q$, and choosing a direction in $q_j$.''

The composition product has many surprises up its sleeve, as we'll see. We've told many of them to you already in \cref{subsec.math_theory}. We won't amass them all here; instead, we'll take you through the story step by step. But as a preview, this chapter will get us into decision trees, databases, and more dynamics, and it's all based on $\circ$.

As in \cref{eqn.sum_p1}, we'll continue to denote polynomials with the following notation
\begin{equation}\label{eqn.sum_p1_again}
p\cong\sum_{i\in p(\1)}\yon^{p_i},
\end{equation}
and refer to $p(\1)$ as the set of positions, and for each $i\in p(\1)$ we'll refer to $p_i$ as the set of direction at position $i$.

%-------- Section --------%
\section{The composition product}

We begin with the definition of composition product.

\begin{proposition}
Suppose $p,q\in\poly$ are polynomial functors $p,q\colon\smset\to\smset$. Then their composite $p\circ q$ is again a polynomial functor and we have the following isomorphisms
\begin{equation}\label{eqn.composite_formula}
p\circ q\cong\sum_{i\in p(\1)}\prod_{d\in p_i}\sum_{j\in q(\1)}\prod_{e\in q_j}\yon.
\end{equation}
\end{proposition}
\begin{proof}
We can rewrite \cref{eqn.sum_p1_again} for $p$ and $q$ as
\[
p\cong\sum_{i\in p(\1)}\prod_{d\in p_i}\yon
\qqand
q\cong\sum_{j\in q(\1)}\prod_{e\in q_j}\yon.
\]
For any set $X$ we have $(p\circ q)(X)=p(q(X))=p(\sum_j\prod_e X)=\sum_i\prod_d\sum_j\prod_eX$, so \eqref{eqn.composite_formula} is indeed the formula for their composite. To see this is a polynomial, we use \cref{prop.completely_distributive}, which says we can rewrite the $\prod\sigma$ in \eqref{eqn.composite_formula} as a $\sigma\prod$. The result 
\begin{equation}\label{eqn.composition_formula_sums_first}
  p\circ q\cong
  \scalebox{1.3}{$\displaystyle
  \sum_{i\in p(\1)}\sum_{j_i\colon p_i\to q(\1)}\yon^{\sum_{d\in p_i}q_{j_i(d)}},$}
\end{equation}
(written slightly bigger for clarity) is clearly a polynomial.
\end{proof}

\begin{exercise}
Let's consider \eqref{eqn.composition_formula_sums_first} piece by piece, with concrete polynomials $p\coloneqq\yon^\2+\yon$ and $q\coloneqq \yon^\3+\1$. Note that $p_1=\2$ and $p_2=\1$.
\begin{enumerate}
	\item What is $q^\2$?
	\item What is $\yon^2\circ q$?
	\item What is $\yon\circ q$?
	\item What is $(\yon^\2+\yon)\circ q$? This is what $p\circ q$ ``should be''.
	\item How many functions $j_1\colon p_1\to q(\1)$ are there?
	\item For each function $j_1$ as above, what is $\sum_{d\in p_1} q_{j_1(d)}$?
	\item How many functions $j_2\colon p_2\to q(\2)$ are there?
	\item For each function $j_2$ as above, what is $\sum_{d\in p_2} q_{j_2(d)}$?
	\item Write out $\sum_{i\in p(\1)}\sum_{j_i\colon p_i\to q(\1)}\yon^{\sum_{d\in p_i}q_{j_i(d)}}$.
	\item Does the result agree with what $p\circ q$ should be?
\qedhere
\end{enumerate}
\end{exercise}

In terms of corollas, composition product $p\circ q$ is given by stacking $q$-corollas on top of $p$-corollas in every possible way. Let's say $p\coloneqq\yon^\2+\yon$ and $q\coloneqq\yon^\3+\1$, which as in \cref{eqn.trees_for_gazing} we draw as follows
\begin{equation}\label{eqn.pq_misc39}
\begin{tikzpicture}[rounded corners]
	\node (p1) [draw, blue!50!black, "$p$" above] {
	\begin{tikzpicture}[trees, sibling distance=2.5mm]
    \node["\tiny 1" below] (1) {$\bullet$} 
      child {}
      child {};
    \node[right=.5 of 1,"\tiny 2" below] (2) {$\bullet$} 
      child {};
  \end{tikzpicture}
  };
%
	\node (p2) [draw, red!50!black, right=2 of p1, "$q$" above] {
	\begin{tikzpicture}[trees, sibling distance=2.5mm]
    \node["\tiny 1" below] (1) {$\bullet$} 
      child {}
      child {}
      child {};
    \node[right=.5 of 1,"\tiny 2" below] (4) {$\bullet$}
    ;
  \end{tikzpicture}
  };
\end{tikzpicture}
\end{equation}
Then their composite $p\circ q$ would be drawn like so:
\[
\begin{tikzpicture}[rounded corners]
	\node (p1) [draw, "$p\circ q$" above] {
	\begin{tikzpicture}[trees,
		level 1/.style={sibling distance=8mm},
	  level 2/.style={sibling distance=2.5mm}]
    \node[blue!50!black] (1) {$\bullet$} 
      child {node[red!50!black] {$\bullet$} 
      	child
				child
				child
			}
      child {node[red!50!black] {$\bullet$} 
      	child
				child
				child
			};
%
    \node[blue!50!black, right=1.7 of 1] (2) {$\bullet$} 
      child {node[red!50!black] {$\bullet$} 
      	child
				child
				child
			}
      child {node[red!50!black] {$\bullet$} 
			};
%
    \node[blue!50!black, right=1.5 of 2] (3) {$\bullet$} 
      child {node[red!50!black] {$\bullet$} 
			}
      child {node[red!50!black] {$\bullet$} 
      	child
				child
				child
			};
%
    \node[blue!50!black, right=1.5 of 3] (4) {$\bullet$} 
      child {node[red!50!black] {$\bullet$}
			}
      child {node[red!50!black] {$\bullet$} 
			};
%
    \node[blue!50!black, right=1.2 of 4] (5) {$\bullet$} 
      child {node[red!50!black] {$\bullet$} 
      	child
				child
				child
			};
%
    \node[blue!50!black, right=1.2 of 5] (6) {$\bullet$} 
      child {node[red!50!black] {$\bullet$} 
			};
  \end{tikzpicture}
  };
\end{tikzpicture}
\]
It has six positions; the first has six directions, the second, third, and fifth have three directions, and the fourth and sixth have no directions. In total, we read off that $p\circ q$ is isomorphic to $\yon^\6+\3\yon^\3+\2$.

\begin{exercise}
Use $p,q$ as in \cref{eqn.pq_misc39} and $r\coloneqq \yon^\2+\1$ in the following.
\begin{enumerate}
	\item Draw $q\circ p$.
	\item Draw $p\circ p$.
	\item Draw $p\circ p\circ 1$.
	\item Draw $r\circ r$.
	\item Draw $r\circ r\circ r$.
\qedhere
\end{enumerate}
\end{exercise}

\begin{example}\label{ex.apply_2}
For any set $X$ and polynomial $p$, we can take $p(X)\in\smset$; indeed $p\colon\smset\to\smset$ is a functor! In particular, by this point you've seen us write $p(\1)$ hundreds of times. But we've also seen that $X$ is itself a polynomial, namely a constant one.

It's not hard to see that $p(X)\cong p\circ X$. Here's a picture, where $p\coloneqq\yon^\3+\yon+\1$ and $X\coloneqq\2$.
\[
\begin{tikzpicture}[rounded corners]
	\node (p1) [draw, blue!50!black, "$p$" above] {
	\begin{tikzpicture}[trees, sibling distance=2.5mm]
    \node["\tiny 1" below] (1) {$\bullet$} 
      child {}
      child {}
      child {};
    \node[right=.5 of 1,"\tiny 2" below] (2) {$\bullet$} 
      child {};
      ;
    \node[right=.5 of 2,"\tiny 3" below] (3) {$\bullet$} 
      ;
  \end{tikzpicture}
  };
%
	\node (p2) [draw, red!50!black, right=2 of p1, "$X$" above] {
	\begin{tikzpicture}[trees, sibling distance=2.5mm]
    \node["\tiny 1" below] (1) {$\bullet$};
    \node[right=.5 of 1,"\tiny 2" below] (4) {$\diamond$};
    \node[above=10pt of 4] {};
    ;
  \end{tikzpicture}
  };
\end{tikzpicture}
\]
Let's see how $(\yon^\3+\yon+\1)\circ\2$ looks.
\[
\begin{tikzpicture}[rounded corners]
	\node (p1) [draw, "$p\circ X$" above] {
	\begin{tikzpicture}[trees, sibling distance=2.5mm]
    \node[blue!50!black] (1) {$\bullet$} 
      child {node[red!50!black] {$\bullet$}}
      child {node[red!50!black] {$\bullet$}}
      child {node[red!50!black] {$\bullet$}};
    \node[blue!50!black, right=of 1] (2) {$\bullet$} 
      child {node[red!50!black] {$\bullet$}}
      child {node[red!50!black] {$\bullet$}}
      child {node[red!50!black] {$\diamond$}};
    \node[blue!50!black, right=of 2] (3) {$\bullet$} 
      child {node[red!50!black] {$\bullet$}}
      child {node[red!50!black] {$\diamond$}}
      child {node[red!50!black] {$\bullet$}};
    \node[blue!50!black, right=of 3] (4) {$\bullet$} 
      child {node[red!50!black] {$\bullet$}}
      child {node[red!50!black] {$\diamond$}}
      child {node[red!50!black] {$\diamond$}};
    \node[blue!50!black, right=of 4] (5) {$\bullet$} 
      child {node[red!50!black] {$\diamond$}}
      child {node[red!50!black] {$\bullet$}}
      child {node[red!50!black] {$\bullet$}};
    \node[blue!50!black, right=of 5] (6) {$\bullet$} 
      child {node[red!50!black] {$\diamond$}}
      child {node[red!50!black] {$\bullet$}}
      child {node[red!50!black] {$\diamond$}};
    \node[blue!50!black, right=of 6] (7) {$\bullet$} 
      child {node[red!50!black] {$\diamond$}}
      child {node[red!50!black] {$\diamond$}}
      child {node[red!50!black] {$\bullet$}};
    \node[blue!50!black, right=of 7] (8) {$\bullet$} 
      child {node[red!50!black] {$\diamond$}}
      child {node[red!50!black] {$\diamond$}}
      child {node[red!50!black] {$\diamond$}};
    \node[blue!50!black, right=.8 of 8] (9) {$\bullet$} 
      child {node[red!50!black] {$\bullet$}};
    \node[blue!50!black, right=.6 of 9] (10) {$\bullet$} 
      child {node[red!50!black] {$\diamond$}};
    \node[blue!50!black, right=.6 of 10] (11) {$\bullet$};
	\end{tikzpicture}
	};
\end{tikzpicture}
\]
It has $11$ positions and no open leaves, which means it's a set (constant polynomial), namely $p\circ X\cong \1\1$.

We could also draw $X\circ p$, since both are perfectly valid polynomials. Here it is:
\[
\begin{tikzpicture}[rounded corners]
	\node (p2) [draw, red!50!black, "$X\circ p$" above] {
	\begin{tikzpicture}[trees, sibling distance=2.5mm]
    \node["\tiny 1" below] (1) {$\bullet$};
    \node[right=.5 of 1,"\tiny 2" below] (4) {$\diamond$};
    \node[above=10pt of 4] {};
    ;
  \end{tikzpicture}
  };
\end{tikzpicture}
\]
Each of the open leaves in $X$---of which there are none---is filled with a corolla from $p$.
\end{example}

\begin{exercise}
Choose a polynomial $p$ and draw $p\circ\1$ in the style of \cref{ex.apply_2}.
\end{exercise}

\paragraph{Monoidal structure of $(\circ,\yon)$.}
The technical claim is that $\circ$ is a monoidal product, which means that it's well-behaved, in particular it's functorial, associative, and unital. Let's start with functoriality.

For any $f\colon p\to q$ and $f'\colon p'\to q'$, we want to define a morphism $(f\circ f')\colon(p\circ p')\to(q\circ q')$. This is actually quite an impressive operation! It threads back and forth in a fascinating way. 

Recall from \cref{ex.practice_with_poly_morphisms} that we can think of $f=(f_1,f^\sharp)$ as a way to delegate decisions from $p$ to $q$. Every decision (corolla / position) $i\in p(\1)$ is assigned a decision $f_1(i)\in q(\1)$. Then every option $e\in q_{f_1(i)}$ there is passed back to an option $f^\sharp(e)\in p_i$. Let's start with an example and then give the general method.

\begin{example}
Let's take $p\coloneqq \yon^\2+\yon$, $p'\coloneqq\yon^\2+\yon$, $q\coloneqq\yon^\3+\yon$, and $q'\coloneqq\yon+\1$.
\[
\begin{tikzpicture}[rounded corners]
	\node (p) [draw, blue!50!black, "$p$" above] {
	\begin{tikzpicture}[trees, sibling distance=5mm]
    \node["\tiny 1" below] (1) {$\bullet$} 
      child {}
      child {};
    \node[right=.5 of 1,"\tiny 2" below] (2) {$\bullet$} 
      child {};
  \end{tikzpicture}
  };
%
	\node (p') [draw, blue, above=1 of p, "$p'$" above] {
	\begin{tikzpicture}[trees, sibling distance=2.5mm]
    \node["\tiny 1" below] (1) {$\bullet$} 
      child {}
      child {};
    \node[right=.5 of 1,"\tiny 2" below] (2) {$\bullet$} 
      child {};
  \end{tikzpicture}
  };
	\node (q) [draw, red!50!black, right=3 of p, "$q$" above] {
	\begin{tikzpicture}[trees, sibling distance=2.5mm]
    \node["\tiny 1" below] (1) {$\bullet$} 
      child {}
      child {}
      child {};
    \node[right=.5 of 1,"\tiny 2" below] (2) {$\bullet$}
      child {};
  \end{tikzpicture}
  };
	\node (q') [draw, red, above=1 of q, "$q'$" above] {
	\begin{tikzpicture}[trees, sibling distance=2.5mm]
    \node["\tiny 1" below] (1) {$\bullet$} 
      child {};
    \node[right=.5 of 1,"\tiny 2" below] (2) {$\bullet$}
    ;
  \end{tikzpicture}
  };
\end{tikzpicture}
\]
For any way to delegate from $p$ to $q$ and $p'$ to $q'$, we're supposed to give a way to delegate from $(p\circ p')$ to $q\circ q'$. Let's draw $p\circ p'$ and $q\circ q'$.
\[
\begin{tikzpicture}[rounded corners]
	\node (p1) [draw, "$p\circ p'$" above] {
	\begin{tikzpicture}[trees,
		level 1/.style={sibling distance=8mm},
	  level 2/.style={sibling distance=2.5mm}]
    \node[blue!50!black] (1) {$\bullet$} 
      child {node[blue] {$\bullet$} 
      	child
				child
			}
      child {node[blue] {$\bullet$} 
      	child
				child
			};
%
    \node[blue!50!black, right=1.7 of 1] (2) {$\bullet$} 
      child {node[blue] {$\bullet$} 
				child
				child
			}
      child {node[blue] {$\bullet$} 
				child
			};
%
    \node[blue!50!black, right=1.5 of 2] (3) {$\bullet$} 
      child {node[blue] {$\bullet$} 
      	child
			}
      child {node[blue] {$\bullet$} 
				child
				child
			};
%
    \node[blue!50!black, right=1.5 of 3] (4) {$\bullet$} 
      child {node[blue] {$\bullet$} 
      	child
			}
      child {node[blue] {$\bullet$} 
				child
			};
%
    \node[blue!50!black, right=1.2 of 4] (5) {$\bullet$} 
      child {node[blue] {$\bullet$} 
      	child
      	child
			};
%
    \node[blue!50!black, right=.8 of 5] (6) {$\bullet$} 
      child {node[blue] {$\bullet$} 
      	child
			};
  \end{tikzpicture}
  };
\end{tikzpicture}
\]
\[
\begin{tikzpicture}[rounded corners]
	\node (p1) [draw, "$q\circ q'$" above] {
	\begin{tikzpicture}[trees,
		level 1/.style={sibling distance=4mm},
	  level 2/.style={sibling distance=2.5mm}]
    \node[red!50!black] (1) {$\bullet$} 
      child {node[red] {$\bullet$} 
      	child
			}
      child {node[red] {$\bullet$} 
      	child
			}
      child {node[red] {$\bullet$} 
				child
			};
%
    \node[red!50!black, right=1.4 of 1] (2) {$\bullet$} 
      child {node[red] {$\bullet$} 
      	child
			}
      child {node[red] {$\bullet$} 
      	child
			}
      child {node[red] {$\bullet$} 
			};
%
    \node[red!50!black, right=1.4 of 2] (3) {$\bullet$} 
      child {node[red] {$\bullet$} 
      	child
			}
      child {node[red] {$\bullet$} 
			}
      child {node[red] {$\bullet$} 
				child
			};
%
    \node[red!50!black, right=1.4 of 3] (4) {$\bullet$} 
      child {node[red] {$\bullet$} 
      	child
			}
      child {node[red] {$\bullet$} 
			}
      child {node[red] {$\bullet$} 
			};
%
    \node[red!50!black, right=1.4 of 4] (5) {$\bullet$} 
      child {node[red] {$\bullet$} 
			}
      child {node[red] {$\bullet$} 
      	child
			}
      child {node[red] {$\bullet$} 
				child
			};
%
    \node[red!50!black, right=1.4 of 5] (6) {$\bullet$} 
      child {node[red] {$\bullet$} 
			}
      child {node[red] {$\bullet$} 
      	child
			}
      child {node[red] {$\bullet$} 
			};
%
    \node[red!50!black, right=1.4 of 6] (7) {$\bullet$} 
      child {node[red] {$\bullet$} 
			}
      child {node[red] {$\bullet$} 
			}
      child {node[red] {$\bullet$} 
      	child
			};
%
    \node[red!50!black, right=1.4 of 7] (8) {$\bullet$} 
      child {node[red] {$\bullet$} 
			}
      child {node[red] {$\bullet$} 
			}
      child {node[red] {$\bullet$} 
			};
    \node[red!50!black, right=1 of 8] (9) {$\bullet$} 
      child {node[red] {$\bullet$} 
      	child
			}
			;
    \node[red!50!black, right=.8 of 9] (10) {$\bullet$} 
      child {node[red] {$\bullet$} 
			}
			;
  \end{tikzpicture}
  };
\end{tikzpicture}
\]

Ok, now suppose someone gives us delegations (morphisms / dependent lenses) $f\colon p\to q$ and $f'\colon p'\to q'$. Let's just pick something relatively at random
\[
\begin{tikzpicture}
	\node (p1) {\raisebox{.3cm}{$f\colon p\to q\hphantom{''}$}\qquad
	\begin{tikzpicture}[trees, sibling distance=2.5mm]
    \node[blue!50!black, "\tiny 1" below] (1) {$\bullet$} 
      child {coordinate (11)}
      child {coordinate (12)};
    \node[right=1.5 of 1, red!50!black, "\tiny 1" below] (2) {$\bullet$} 
      child {coordinate (21)}
      child {coordinate (22)}
      child {coordinate (23)};
    \draw[|->, shorten <= 3pt, shorten >= 3pt] (1) -- (2);
    \begin{scope}[densely dotted, bend right, decoration={markings, mark=at position 0.75 with \arrow{stealth}}]
      \draw[postaction={decorate}] (21) to (12);
      \draw[postaction={decorate}] (22) to (12);
      \draw[postaction={decorate}] (23) to (11);
    \end{scope}
  \end{tikzpicture}	
	};	
%
	\node (p2) [below right=-1.3 and 1 of p1] {
	\begin{tikzpicture}[trees, sibling distance=2.5mm]
    \node[blue!50!black, "\tiny 2" below] (1) {$\bullet$} 
      child {coordinate (11)};
    \node[right=of 1, red!50!black, "\tiny 2" below] (2) {$\bullet$}
      child {coordinate (21)};
    \draw[|->, shorten <= 3pt, shorten >= 3pt] (1) -- (2);
    \begin{scope}[densely dotted, bend right, decoration={markings, mark=at position 0.75 with \arrow{stealth}}]
      \draw[postaction={decorate}] (21) to (11);
		\end{scope}
  \end{tikzpicture}	
	};	
	\node [below=.5 of p1] (p3) {\raisebox{.3cm}{$f'\colon p'\to q'$}\qquad
	\begin{tikzpicture}[trees, sibling distance=2.5mm]
    \node[blue, "\tiny 1" below] (1) {$\bullet$} 
      child {coordinate (11)}
      child {coordinate (12)};
    \node[right=1.5 of 1, red, "\tiny 1" below] (2) {$\bullet$} 
      child {coordinate (21)};
    \draw[|->, shorten <= 3pt, shorten >= 3pt] (1) -- (2);
    \begin{scope}[densely dotted, bend right, decoration={markings, mark=at position 0.75 with \arrow{stealth}}]
      \draw[postaction={decorate}] (21) to (12);
    \end{scope}
  \end{tikzpicture}	
	};	
%
	\node (p4) [below right=-1.05 and 1 of p3] {
	\begin{tikzpicture}[trees, sibling distance=2.5mm]
    \node[blue, "\tiny 2" below] (1) {$\bullet$} 
      child {coordinate (11)};
    \node[right=of 1, red, "\tiny 2" below] (2) {$\bullet$};
    \draw[|->, shorten <= 3pt, shorten >= 3pt] (1) -- (2);
  \end{tikzpicture}	
	};	
\end{tikzpicture}
\]
\spiz{finish}
\end{example}



\begin{proposition}
Composition product, together with $\yon$, forms a monoidal structure $(\yon,\circ)$ on $\poly$.
\end{proposition}
\begin{proof}
\spiz{finish}
\end{proof}





\end{document}